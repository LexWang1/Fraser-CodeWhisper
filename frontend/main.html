<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
     <!-- ÂÅáËÆæ style.css ÂåÖÂê´‰∫Ü‰∏§‰∏™Êñá‰ª∂ÊâÄÈúÄÁöÑÊâÄÊúâÊ†∑Âºè -->
  <link rel="stylesheet" href="style.css">
  <style>
/* Adding necessary styles for functionality */       
.clickable { cursor: pointer; transition: background-color 0.2s; }
    .clickable:hover { background-color: #f0f0f02c; }
    #detail-panel { display: none; }
    .dropdown-menu .dropdown-item { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .dropdown-menu .dropdown-item.active { font-weight: bold; background-color: #f0f0f02c; }
    .section-content.collapsed { display: none; }
    .section-title { cursor: pointer; }
    .delete-portfolio-btn {
        color: #e74c3c;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 16px;
        line-height: 1;
        visibility: hidden; /* Hide by default */
    }
    .dropdown-item:hover .delete-portfolio-btn {
        visibility: visible; /* Show on hover */
        background-color: #ddd;
    }
    .add-new-item {
      font-style: italic;
      color: #3498db;
      text-align: center;
      padding-top: 5px;
      border-top: 1px solid #eee;
    }

    /* --- START: Styles for Buy/Sell Buttons and Transaction Modal --- */
    .account-item-container {
        padding: 10px 15px;
        border-bottom: 1px solid #444; /* Darker border for dark theme */
    }
    /* The original .account-item is now just the top, clickable part */
    .account-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .action-buttons {
        display: flex;
        justify-content: flex-end; /* Align buttons to the right */
        gap: 10px; /* Space between buttons */
        padding-top: 8px; /* Space above buttons */
    }
    .transaction-btn {
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        color: white;
        font-size: 12px;
        transition: background-color 0.2s;
    }
    .transaction-btn.buy {
        background-color: #27ae60; /* Green */
    }
    .transaction-btn.buy:hover {
        background-color: #2ecc71;
    }
    .transaction-btn.sell {
        background-color: #c0392b; /* Red */
    }
    .transaction-btn.sell:hover {
        background-color: #e74c3c;
    }
    /* --- END: Styles for Buy/Sell Buttons --- */
  </style>
</head>
<body>
  <!-- Top Navigation (from financial_test6.html) -->
  <nav class="top-nav">
    <div class="logo">
      <img src="image/team_logo.png" alt="Code Whisper Logo">
    </div>
    <div class="nav-links">
      <div class="dropdown">
        <a href="#" class="dropdown-toggle" id="currentPortfolioName">Personal Portfolios</a>
        <div class="dropdown-menu" id="portfolioList">
          <div class="dropdown-item">Loading...</div>
        </div>
      </div>
    </div>
    <div class="nav-actions">
      <input type="text" placeholder="Search..." class="search-bar">
    </div>
  </nav>

<!-- Add Portfolio Modal -->
<div id="addPortfolioModal" class="modal">
  <div class="modal-content">
   <span class="close-btn" onclick="closeModal('addPortfolioModal')">√ó</span>
     <h3>Add New Portfolio</h3>
    <form id="addPortfolioForm">
         <label for="newPortfolioName">Portfolio Name:</label>
      <input type="text" id="newPortfolioName" required>      
      <button type="submit" class="submit-btn">Add Portfolio</button>
    </form>
  </div>
</div>
<!---update here-->

<!-- Delete Confirmation Modal -->
<div id="deletePortfolioModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('deletePortfolioModal')">√ó</span>
    <h3>Confirm Deletion</h3>
    <p>Are you sure you want to delete the portfolio: "<b id="portfolioNameToDelete"></b>"?</p>
    <p>This action cannot be undone.</p>
    <div id="deleteConfirmButtons">
      <!-- The confirm button will be set by JavaScript -->
    </div>
  </div>
</div>

<!-- START: Generic Transaction Modal -->
<div id="transactionModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('transactionModal')">√ó</span>
    <h3 id="transaction-title">Transaction</h3>
    <form id="transactionForm">
      <!-- Hidden fields to store context -->
      <input type="hidden" id="transactionStockId">
      <input type="hidden" id="transactionType">
      
      <label for="transactionAmount">Amount($):</label>
      <input type="number" id="transactionAmount" required placeholder="For example: 500.00" step="any" min="0">
      
      <label for="transactionDate">Date:</label>
      <input type="date" id="transactionDate" required>
      
      <button type="submit" class="submit-btn">Submit</button>
    </form>
  </div>
</div>
<!-- END: Generic Transaction Modal -->


  <div class="container">
       <div class="sidebar" id="sidebar">
            <!-- Net worth section is static, the rest will be generated dynamically -->
            <div class="net-worth-section clickable" onclick="switchView('overview')">
                <div class="net-worth-title">NET WORTH</div>
                <div class="net-worth-amount" id="total">$0.00</div>
            </div>
            <!-- Dynamic content will be injected here -->
        </div>

        <!-- VIEW 1: Main Overview Panel (from financial_test6) -->
        <div class="right-panel" id="overview-panel">
            <div class="carousel">
                <button class="carousel-arrow left" onclick="prevSlide()">&#8249;</button>
                <div class="carousel-inner" id="carouselInner">

                    <div class="carousel-slide">
                        <h3 class="chart-title">Portfolio Value Over Time</h3>
                           <!-- <canvas id="overviewNetWorthChart"></canvas> -->
                             <div class="controls" style="margin-top: -15px;">
                                <label for="startDate">Start Date:</label>
                                <input type="date" id="startDate" value="2025-05-20">
                            </div>
                          
                       <div id="overviewNetWorthChart" style="margin-top: -15px;"></div>
                                                                                 
                                                                       
                    </div> 

                    <div class="carousel-slide">
                        <h3 class="chart-title">Cash Flow</h3>
                        <div style="display:flex;justify-content:space-around;align-items:center;">
                        <div class="donut-container">
                        <div class="donut-chart">
                            <div id="incomeChart" style="width: 350px; height: 350px;margin-top: -20px;"></div>
                            <div style="text-align: center; margin-top: -40px;">
                                <div style="font-weight: 600; color: #666;">Gains</div>
                                <!--<div style="font-size: 20px; font-weight: 700; color: #3498db;">$18,665</div>-->
                                <div id="gain-amount" style="font-size: 20px; font-weight: 700; color: #3498db;">$0.00</div>
                            </div>
                        </div>
                        <div class="donut-chart">
                            <div id="spendingChart" style="width: 350px; height: 350px;margin-top: -20px;"></div>
                            <div style="text-align: center; margin-top: -40px;">
                                <div style="font-weight: 600; color: #666;">Losses</div>
                                <!--<div style="font-size: 20px; font-weight: 700; color: #e74c3c;">$42,500</div>--->
                                <div id="spending-amount" style="font-size: 20px; font-weight: 700; color: #e74c3c;">$0.00</div>

                            </div>
                        </div>
                        </div>

                        </div>
                    </div>

                    </div>
               
                <button class="carousel-arrow right" onclick="nextSlide()">&#8250;</button>
            
            </div>
            <div class="three-columns">
                <div class="market-section">
                <h3 class="chart-title">Market Movers</h3>
                <div class="market-indices">
                    <div class="index-card"><div class="index-change positive" id="GSPC">0</div><div>S&P 500</div></div>
                    <div class="index-card"><div class="index-change negative" id="DJI">0</div><div>DOW JONES</div></div>
                    <div class="index-card"><div class="index-change positive" id="IXIC">0</div><div>NASDAQ</div></div>
                    <div class="index-card"><div class="index-change negative" id="TNX">0</div><div>10 YR BOND</div></div>
                </div>
                </div>
                <div class="market-section">
                    <h3 class="holdings-title">Your Gainers</h3>
                    <div id="gainers-list">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>
                <div class="market-section">
                    <h3 class="holdings-title">Your Losers</h3>
                    <div id="losers-list">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>
            </div>
            <div class="bottom-section">
                <div class="insights">
                <h3 class="insights-title">TOP NEWS</h3>
                <!-- Âä®ÊÄÅÊõ¥Êñ∞newsÁöÑÂú∞Êñπ -->
                <div class="insight-item" id="topNews1">News is Loading...</div>
                <div class="insight-item" id="topNews2">News is Loading...</div>
                <div class="insight-item" id="topNews3">News is Loading...</div>
                <!-- <div class="insight-item" id="topNews4">News is Loading...</div> -->
                </div>
                <div class="contact-section">
                <h3 class="contact-title">Contact Us</h3>
                <p>Email: support@codewhisper.com</p>
                <p>Phone: +1 (555) 123-4567</p>
                <h4 class="subscribe-title">Subscribe to Updates</h4>
                <input type="email" placeholder="Enter your email" class="subscribe-input">
                <button class="subscribe-btn">Subscribe</button>
                <div class="copyright">¬© 2025 Code Whisper. All Rights Reserved.</div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: Asset Detail Panel (from ai_studio_code (5)) -->
        <main class="main-content" id="detail-panel">
            <!-- Â§¥ÈÉ®‰ø°ÊÅØÁé∞Âú®ÊòØ main-content ÁöÑÁõ¥Êé•Â≠êÂÖÉÁ¥†Ôºå‰Ωç‰∫é grid ‰∏äÊñπ -->
            <div class="dashboard-header">
                <h1 class="dashboard-title" id="asset-name">Tesla</h1>
                <div class="net-worth-display">
                    <div class="net-worth-main" id="asset-price">$1,234,567</div>
                    <div class="net-worth-change" id="asset-change">Rise / Fall: +0.17%</div>
                </div>
            </div>

            <!-- ÁΩëÊ†ºÂ∏ÉÂ±ÄÁé∞Âú®‰Ωç‰∫é header ‰∏ãÊñπ -->
            <div class="dashboard-grid">
                <div class="left-column">
                    
                    <div class="chart-container">
                         <div class="controls" style="margin-top: -5px;">
                                <label for="detailStartDate">Start Date:</label>
                                <input type="date" id="detailStartDate" value="2025-05-20">
                            </div>
                            
                         <div id="assetDetailChart"  style="width: 100%; height: 400px;"></div> 
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Recent Transactions</h3>
                        <table class="transaction-table">
                            <thead><tr><th>Action</th><th>Price ($)</th><th>Quantity</th><th>Time</th></tr></thead>
                            <tbody id="transaction-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="right-column">
                    <div class="market-movers">
                        <h3 class="chart-title">Related News</h3>
                        <div class="news-list" id="news-list"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CENTRALIZED SCRIPT ---

        // 1. GLOBAL STATE
        let allPortfolios = [];
        let currentPortfolioIndex = 0;
        let portfolioData = null; // Holds the *adapted* data for the current portfolio
        let assetDetailChart = null;
        let usd = 1000; // Base cash amount
        //let localPortfolios = []; // For the add/delete modal functionality
        let overviewChart = null; // ECharts instance for the overview chart
        let _rawData = []; // To store historical price data from all_data.json
        let currentPortfolioId = null;
        let portfolioHistoryCache = null;

        // 2. HELPER FUNCTIONS
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            return isoString.replace('T', ' ').replace(/-/g, '/').substring(0, 16);
        }

        // 3. DATA ADAPTER
        /**
         * Converts a single portfolio object from the JSON into the format
         * used by the rendering functions (showAsset, initializePortfolio).
         * @param {object} portfolio - A single portfolio object from the main data file.
         * @returns {object} - Data formatted for internal use.
         */
        function adaptDataStructure(portfolio) {
            const adaptedData = {};
            if (!portfolio || !portfolio.holdings) return {};

            portfolio.holdings.forEach(asset => {
                const assetType = asset.assetType;
                if (!adaptedData[assetType]) {
                    adaptedData[assetType] = {};
                }
                adaptedData[assetType][asset.stockId] = {
                    name: asset.assetName,
                    price: asset.currentPrice,//TODOÔºöÊîπÊàêÈÄöËøáAPIËé∑Âèñ
                    history:asset.currentPrice,
                    changePercent: asset.changePercent,//TODO
                    holding: asset.quantity,
                    priceHistory: asset.priceHistory,
                    news: asset.news,
                    transactions: (asset.transactions || []).map(tx => ({
                        action: tx.type.charAt(0).toUpperCase() + tx.type.slice(1),
                        price: tx.price,
                        quantity: tx.quantity,
                        time: formatTimestamp(tx.timestamp)
                    })).sort((a, b) => new Date(b.time) - new Date(a.time))
                };
            });
            return adaptedData;
        }

        // 4. DYNAMIC UI BUILDERS
        /**
         * Populates the portfolio switching dropdown menu.
         */
        function updatePortfolioDropdown() {
            const portfolioList = document.getElementById("portfolioList");
            const currentPortfolioNameEl = document.getElementById("currentPortfolioName");
            portfolioList.innerHTML = '';

         if (allPortfolios.length === 0) {
                currentPortfolioNameEl.textContent = "No Portfolios";
            } else {
                currentPortfolioNameEl.textContent = "My Portfolios";
            }
            // currentPortfolioNameEl.textContent = allPortfolios[currentPortfolioIndex].name;
            //currentPortfolioNameEl.textContent = "Portfolios";

            allPortfolios.forEach((p, index) => {
                const item = document.createElement("div");
                item.className = "dropdown-item";
                if (index === currentPortfolioIndex) {
                    item.classList.add('active');
                }
                
                // Portfolio name part, clickable to switch
                const nameSpan = document.createElement("span");
                nameSpan.textContent = p.name;
                nameSpan.style.flexGrow = "1"; // Make name take available space
                nameSpan.onclick = (e) => {
                    e.stopPropagation(); // Prevent delete from triggering
                    if (index !== currentPortfolioIndex) {
                        renderDashboard(index);
                    }
                };

                // Delete button part
                const deleteBtn = document.createElement("span");
                deleteBtn.className = "delete-portfolio-btn";
                deleteBtn.innerHTML = "√ó"; // 'x' symbol
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent switch from triggering
                    openDeleteConfirmation(index);
                };

                item.appendChild(nameSpan);
                item.appendChild(deleteBtn);
                portfolioList.appendChild(item);
            });
            
            // Add the "Add New" button at the end
            const addItem = document.createElement("div");
            addItem.className = "dropdown-item add-new-item";
            addItem.textContent = "+ Add New Portfolio";
            addItem.onclick = () => openModal('addPortfolioModal');
            portfolioList.appendChild(addItem);
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function handleAddPortfolio(event) {
            event.preventDefault();
            const input = document.getElementById("newPortfolioName");
            const newName = input.value.trim();

            if (newName && !allPortfolios.some(p => p.name.toLowerCase() === newName.toLowerCase())) {
                const newPortfolio = {
                    name: newName,
                    holdings: [] // Create a new portfolio with no holdings
                };
                allPortfolios.push(newPortfolio);
                
                input.value = ''; // Reset form
                closeModal('addPortfolioModal');
                renderDashboard(allPortfolios.length - 1); // Switch to the new portfolio
            } else if (!newName) {
                alert("Portfolio name cannot be empty.");
            } else {
                alert("A portfolio with this name already exists.");
            }
        }

        function openDeleteConfirmation(index) {
            const portfolio = allPortfolios[index];
            if (!portfolio) return;

            document.getElementById('portfolioNameToDelete').textContent = portfolio.name;
            
            const confirmButtonsDiv = document.getElementById('deleteConfirmButtons');
            confirmButtonsDiv.innerHTML = `
                <button class="submit-btn delete-btn" onclick="deletePortfolio(${index})">Delete</button>
                <button class="submit-btn" onclick="closeModal('deletePortfolioModal')">Cancel</button>
            `;
            
            openModal('deletePortfolioModal');
        }

        function deletePortfolio(index) {
            allPortfolios.splice(index, 1);
            closeModal('deletePortfolioModal');
            
            if (currentPortfolioIndex >= index) {
                currentPortfolioIndex = Math.max(0, allPortfolios.length - 1);
            }

            if (allPortfolios.length > 0) {
                renderDashboard(currentPortfolioIndex);
            } else {
                portfolioData = {};
                buildSidebar({ name: "None", holdings: [] });
                updatePortfolioDropdown();
                initializePortfolioValues();
                updateMarketMovers();
                switchView('overview');
                document.getElementById('total').textContent = '$0.00';
                document.getElementById('gainers-list').innerHTML = 'No portfolios to display.';
                document.getElementById('losers-list').innerHTML = '';
            }
        }


        // --- MODIFIED: Functions for the new transaction modal ---
        function openTransactionModal(type, stockId) {
            const typeText = type === 'Buy' ? 'Buy' : 'Sell';
            document.getElementById('transaction-title').textContent = `${typeText} ${stockId}`;
            document.getElementById('transactionStockId').value = stockId;
            document.getElementById('transactionType').value = type;
            
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;

            // Clear previous amount
            document.getElementById('transactionAmount').value = '';

            openModal('transactionModal');
        }

        function handleTransactionSubmit(event) {
            event.preventDefault(); // Prevent actual form submission for this demo
            const stockId = document.getElementById('transactionStockId').value;
            const type = document.getElementById('transactionType').value;
            const amount = document.getElementById('transactionAmount').value;
            const date = document.getElementById('transactionDate').value;

            // In a real app, you would send this data to a server
            alert(`Ë°®ÂçïÂ∑≤Êèê‰∫§ (‰ªÖ‰∏∫ÊºîÁ§∫):\nÁ±ªÂûã: ${type}\nËµÑ‰∫ß: ${stockId}\nÈáëÈ¢ù: $${amount}\nÊó•Êúü: ${date}`);

            closeModal('transactionModal');
        }

        /**
         * Dynamically builds the sidebar based on the current portfolio's holdings.
         * @param {object} portfolio - The currently active portfolio object.
         */
        function buildSidebar(portfolio) {
             const sidebar = document.getElementById('sidebar');
    const netWorthSection = sidebar.querySelector('.net-worth-section');
    sidebar.innerHTML = ''; // Clear everything
    sidebar.appendChild(netWorthSection); // Add back the net worth section

    const holdingsByType = portfolio.holdings.reduce((acc, holding) => {
        const type = holding.assetType === 'forex' ? 'cash' : holding.assetType;
        if (!acc[type]) acc[type] = [];
        acc[type].push(holding);
        return acc;
    }, {});


            // 1. Always create CASH section
             const cashSection = document.createElement('div');
    cashSection.className = 'section cash-section'; // <-- Added specific class
    cashSection.innerHTML = `
        <div class="section-title" onclick="toggleSection('cash')">CASH</div>
        <div class="section-content" id="cash-content">
            <div class="account-item">
                <div><div class="account-name"><b>USD</b></div></div>
                <div class="account-amount" id="usd"></div>
            </div>
        </div>`;
        const cashContent = cashSection.querySelector('#cash-content');

            if (holdingsByType.cash) {
                holdingsByType.cash.forEach(holding => {
                    const item = document.createElement('div');
                    item.className = 'account-item clickable';
                    item.setAttribute('onclick', `showAsset('${holding.assetType}', '${holding.stockId}')`);
                    item.innerHTML = `
                        <div>
                            <div class="account-name">${holding.stockId}</div>
                            <div class="account-details">${holding.assetName}</div>
                        </div>
                        <div class="account-amount" id="${holding.stockId.toLowerCase()}-holding-value"></div>`;
                    cashContent.appendChild(item);
                });
            }
    sidebar.appendChild(cashSection);
    delete holdingsByType.cash;

            // 2. Create other sections dynamically
            Object.keys(holdingsByType).sort().forEach(type => {
        const section = document.createElement('div');
        section.className = `section ${type}-section`; // <-- Added type-specific class
        const sectionContentId = `${type}-content`;
        section.innerHTML = `
            <div class="section-title" onclick="toggleSection('${type}')">${type.toUpperCase()}</div>
            <div class="section-content" id="${sectionContentId}"></div>`;
        const sectionContent = section.querySelector(`#${sectionContentId}`);

        holdingsByType[type].forEach(holding => {
            const item = document.createElement('div');
            item.className = 'account-item-container'; 
            item.innerHTML = `
                        <div class="account-item clickable" onclick="showAsset('${holding.assetType}', '${holding.stockId}')">
                            <div>
                                <div class="account-name">${holding.stockId}</div>
                                <div class="account-details">${holding.assetName}</div>
                            </div>
                            <div class="account-amount" id="${holding.stockId.toLowerCase()}-holding-value"></div>
                        </div>
                        <div class="action-buttons">
                            <button class="transaction-btn buy" onclick="openTransactionModal('Buy', '${holding.stockId}')">Buy</button>
                            <button class="transaction-btn sell" onclick="openTransactionModal('Sell', '${holding.stockId}')">Sell</button>
                        </div>
                    `;
                    sectionContent.appendChild(item);
                });
                sidebar.appendChild(section);
            });
        }


        // 5. CORE FUNCTIONALITY
        function switchView(viewName) {
            const overviewPanel = document.getElementById('overview-panel');
            const detailPanel = document.getElementById('detail-panel');
            if (viewName === 'overview') {
                overviewPanel.style.display = 'block';
                detailPanel.style.display = 'none';
                  if (overviewChart) overviewChart.resize(); // Á°Æ‰øùÂõæË°®Âú®ËßÜ
            } else if (viewName === 'detail') {
                overviewPanel.style.display = 'none';
                detailPanel.style.display = 'flex';
                detailPanel.style.flexDirection = 'column';
                 if (assetDetailChartInstance) assetDetailChartInstance.resize();
            }
        }
    
            let currentAssetName = null;
            let assetDetailChartInstance = null;

        function showAsset(assetType, symbol) {
            if (!portfolioData || !portfolioData[assetType] || !portfolioData[assetType][symbol]) {
                console.error("Asset not found:", assetType, symbol);
                return;
            }
            const asset = portfolioData[assetType][symbol];
            switchView('detail');
            
            currentAssetName = symbol;

            document.getElementById('asset-name').textContent = asset.name;
            const priceDisplay = asset.price < 1 ? asset.price.toPrecision(4) : asset.price.toFixed(2);
            document.getElementById('asset-price').textContent = `$${priceDisplay}`;

            const changeEl = document.getElementById('asset-change');
            const isPositive = asset.changePercent >= 0;
            changeEl.textContent = `Rise / Fall: ${isPositive ? '+' : ''}${asset.changePercent.toFixed(2)}%`;
            changeEl.classList.remove('positive', 'negative');
            changeEl.classList.add(isPositive ? 'positive' : 'negative');

            // Update detail chart
            console.log(portfolioData);
            


            setTimeout(() => updateTransactionTable(asset), 0);
            setTimeout(() => updateAssetDetailChartFromJson(symbol, asset), 0);
        
            //const transactionTbody = document.getElementById('transaction-tbody');
            //transactionTbody.innerHTML = asset.transactions.map(tx =>
            //    `<tr><td><span class="action-${tx.action.toLowerCase()}">${tx.action}</span></td><td>${tx.price.toFixed(2)}</td><td>${tx.quantity.toLocaleString()}</td><td>${tx.time}</td></tr>`
            //).join('');

            const newsList = document.getElementById('news-list');
            newsList.innerHTML = asset.news.map(item =>
                `<div class="news-item"><a href="${item.url}" target="_blank" rel="noopener noreferrer" class="news-title-link">${item.title}</a><div class="news-meta"><span class="news-source">${item.source}</span><span class="news-date">${item.date}</span></div></div>`
            ).join('');
            console.log("showAsset executed for", assetType, symbol);
        }
        
function updateAssetDetailChartFromJson(symbol, asset) {
  const startDateInput = document.getElementById('detailStartDate');
  if (!startDateInput) return;

  const startDate = new Date(startDateInput.value);
  console.log("‚è± Start filtering from:", startDate.toISOString());

  // ËØªÂèñ‰ª∑Ê†ºÊï∞ÊçÆ
  $.get('data/all_data.json', function (rawData) {
    const seriesData = rawData
      .filter(d => d.name === symbol)
      .map(d => ({ ...d, dateObj: new Date(d.date) }))
      .filter(d => d.dateObj >= startDate)
      .sort((a, b) => a.dateObj - b.dateObj)
      .map(d => ({
        date: d.date,
        price: d.price
      }));

    // ‚úÖ ËøáÊª§‰∫§ÊòìËÆ∞ÂΩïÔºà‰ªé asset ‰∏≠ÂèñÂá∫Ôºâ
    const filteredTransactions = (asset.transactions || []).filter(tx => {
      const txDate = new Date(tx.timestamp || tx.time); // ÊîØÊåÅ‰∏§ÁßçÂ≠óÊÆµ
      return txDate >= startDate;
    });

    // ‚úÖ ÁªòÂõæ
    updateAssetDetailChart(seriesData, symbol, filteredTransactions);
  });
}


function updateAssetDetailChart(seriesData, assetName, assetTransactions = []) {
  const container = document.getElementById('assetDetailChart');
  if (!container) return;

  if (assetDetailChartInstance != null) {
    assetDetailChartInstance.dispose();
  }

  assetDetailChartInstance = echarts.init(container);

  const priceMap = new Map(seriesData.map(d => [d.date, d.price]));

  const markPoints = assetTransactions.map(tx => {
    const date = new Date(tx.timestamp || tx.time).toISOString().split("T")[0];
    if (!priceMap.has(date)) return null;
    const isBuy = tx.type?.toLowerCase() === 'buy' || tx.action === 'Buy';

    return {
      name: isBuy ? 'Buy' : 'Sell',
      coord: [date, priceMap.get(date)],
      value: tx.quantity,
      itemStyle: {
        color: isBuy ? 'rgba(0, 218, 60, 0.8)' : 'rgba(255, 0, 0, 0.8)',
        borderColor: isBuy ? '#00da3c' : 'red',
        borderWidth: 1.5
      }
    };
  }).filter(p => p !== null);

  const option = {
    animationDuration: 1000,
    dataset: [{ id: 'dataset_raw', source: seriesData }],
    xAxis: { type: 'category', name: 'Date', show: true },
    yAxis: { name: 'Price', show: true },
    grid: { left: 30, right: 40, top: 40, bottom: 40 },
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'cross' },
      formatter: function (params) {
        const index = params[0].dataIndex;
        const date = params[0].axisValue;
        const price =  params[0].data.price || params[0].value;
        const tx = markPoints.find(p => p.coord[0] === date);
        const actionStr = tx
          ? `Action: <span style="color:${tx.itemStyle.color}">${tx.name}</span><br>Quantity: <span style="color:${tx.itemStyle.color}">${tx.value} </span>`
          : '';

        return `
          <div>
            <strong>${date}</strong><br>
            Price: ${price}<br>
            ${actionStr}
          </div>
        `;
      }
    },
    series: [{
      type: 'line',
      datasetId: 'dataset_raw',
      name: assetName,
      showSymbol: false,
      smooth: false,
      encode: { x: 'date', y: 'price', tooltip: ['price'] },
      lineStyle: { width: 3, color: '#3498db' },
      areaStyle: { color: 'rgba(52, 152, 219, 0.1)' },
      emphasis: { focus: 'series' },
      markPoint: {
        symbol: 'circle',
        symbolSize: 10,
        label: { show: false },
        data: markPoints
      }
    }]
  };

  assetDetailChartInstance.setOption(option);
  window.addEventListener('resize', () => assetDetailChartInstance.resize());
}

function buildMarkPoints(transactions, seriesData) {
  const priceMap = new Map(seriesData.map(d => [d.date, d.price]));
  const points = [];

  transactions.forEach(tx => {
    const rawTime = tx.timestamp || tx.time; // ‚úÖ ÊîØÊåÅ‰∏§ÁßçÂ≠óÊÆµÂêç

    if (!rawTime) {
      console.warn("‚õîÔ∏è Êó†Ê≥ïËß£Êûê timestamp:", rawTime, tx);
      return;
    }

    const dateObj = new Date(rawTime);
    if (isNaN(dateObj)) {
      console.warn("‚õîÔ∏è Êó†ÊïàÊó∂Èó¥Ê†ºÂºè:", rawTime, tx);
      return;
    }

    const date = dateObj.toISOString().split("T")[0];
    const price = priceMap.get(date);

    if (price === undefined) {
      console.warn("‚õîÔ∏è Êó•ÊúüÂú® priceMap ‰∏≠Êâæ‰∏çÂà∞:", date);
      return;
    }

    points.push({
      name: (tx.type || tx.action)?.toLowerCase() === 'buy' ? '‰π∞ÂÖ•' : 'ÂçñÂá∫',
      coord: [date, price],
      value: tx.quantity,
      itemStyle: {
        color: (tx.type || tx.action)?.toLowerCase() === 'buy' ? '#00da3c' : 'red'
      }
    });
  });

  return points;
}

document.addEventListener('DOMContentLoaded', () => {
  const detailStartDateInput = document.getElementById('detailStartDate');
  if (detailStartDateInput) {
    detailStartDateInput.addEventListener('change', () => {
      if (currentAssetName && portfolioData) {
        // ÈÅçÂéÜ portfolioData ‰∏≠ÊâÄÊúâ assetType ÊâæÂà∞ÂΩìÂâç asset
        for (const assetType in portfolioData) {
          if (portfolioData[assetType][currentAssetName]) {
            const asset = portfolioData[assetType][currentAssetName];
            updateAssetDetailChartFromJson(currentAssetName, asset);
            break;
          }
        }
      }
    });
  }
});


        function initializePortfolioValues() {
            if (!portfolioData) {
              document.getElementById('total').textContent = '$0.00';
              document.getElementById('usd').textContent = '$0.00';
              return;
            };
            let totalValue = usd;
            document.getElementById('usd').textContent = `$${usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            for (const assetType in portfolioData) {
                for (const symbol in portfolioData[assetType]) {
                    const asset = portfolioData[assetType][symbol];
                    const holdingValue = (asset.holding > 0 ? asset.holding : 0) * asset.price;
                    totalValue += holdingValue;
                    const element = document.getElementById(`${symbol.toLowerCase()}-holding-value`);
                    if (element) {
                        element.textContent = `$${(asset.holding * asset.price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                }
            }
            document.getElementById('total').textContent = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function updateMarketMovers() {
            if (!portfolioData) return;

            const gainersListEl = document.getElementById('gainers-list');
            const losersListEl = document.getElementById('losers-list');
            gainersListEl.innerHTML = ''; 
            losersListEl.innerHTML = '';
            
            if (!portfolioData || Object.keys(portfolioData).length === 0) {
                 gainersListEl.innerHTML = '<div class="holding-item"><span>No holdings to display.</span></div>';
                 losersListEl.innerHTML = '';
                 return;
            }

            let allAssets = [];
            for (const assetType in portfolioData) {
                for (const symbol in portfolioData[assetType]) {
                    const asset = portfolioData[assetType][symbol];
                    if (asset.price != null && asset.changePercent != null && asset.holding > 0) {
                        const changeAmount = asset.price * (asset.changePercent / 100) * asset.holding;
                        allAssets.push({
                            name: asset.name,
                            changePercent: asset.changePercent,
                            changeAmount: changeAmount
                        });
                    }
                }
            }

            const gainers = allAssets.filter(a => a.changeAmount > 0).sort((a, b) => b.changeAmount - a.changeAmount);
            const losers = allAssets.filter(a => a.changeAmount < 0).sort((a, b) => a.changeAmount - b.changeAmount);

            const topGainers = gainers.slice(0, 3);
            const topLosers = losers.slice(0, 3);

            if (topGainers.length > 0) {
                topGainers.forEach(asset => {
                    gainersListEl.innerHTML += `<div class="holding-item"><span>${asset.name}</span><span class="positive">+${asset.changePercent.toFixed(2)}%</span></div>`;
                });
            } else {
                gainersListEl.innerHTML = '<div class="holding-item"><span>No gainers today.</span></div>';
            }

            if (topLosers.length > 0) {
                topLosers.forEach(asset => {
                    losersListEl.innerHTML += `<div class="holding-item"><span>${asset.name}</span><span class="negative">${asset.changePercent.toFixed(2)}%</span></div>`;
                });
            } else {
                losersListEl.innerHTML = '<div class="holding-item"><span>No losers today.</span></div>';
            }
        }



function updateTransactionTable(asset) {
  const tbody = document.getElementById("transaction-tbody");
  if (!tbody) {
    console.warn("‚ö†Ô∏è transaction-tbody not found in DOM");
    return;
  }

  tbody.innerHTML = "";

  if (!asset || !asset.transactions) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color: #aaa;">No transactions found.</td></tr>`;
    return;
  }

  const transactions = asset.transactions;

  transactions.sort((a, b) => new Date(b.time) - new Date(a.time));

  transactions.forEach(tx => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td style="color: ${tx.action.toLowerCase() === 'buy' ? 'green' : 'red'}">${tx.action}</td>
      <td>$${tx.price.toFixed(2)}</td>
      <td>${tx.quantity}</td>
      <td>${tx.time}</td>
    `;
    tbody.appendChild(row);
  });

  console.log(`‚úÖ Transaction table updated for ${currentAssetName} with ${transactions.length} rows.`);
}



       // --- Ê†∏ÂøÉ‰øÆÊîπÈÉ®ÂàÜ ---

        /**
         * [Êñ∞Â¢û] 1. ËÆ°ÁÆóÊäïËµÑÁªÑÂêàÁöÑÂéÜÂè≤ÊÄª‰ª∑ÂÄº
         * @param {Array} holdings - ÂΩìÂâçÊäïËµÑÁªÑÂêàÁöÑÊåÅ‰ªìÂàóË°® (e.g., [{stockId: 'TSLA', quantity: 10}, ...])
         * @param {Array} allPriceData - ÊâÄÊúâËµÑ‰∫ßÁöÑÂéÜÂè≤‰ª∑Ê†º (Êù•Ëá™ all_data.json)
         * @returns {Array} - ‰∏Ä‰∏™ÂåÖÂê´ÊØèÊó•ÊÄª‰ª∑ÂÄºÁöÑÊï∞ÁªÑ (e.g., [{date: '2023-01-01', value: 150000}, ...])
         */
        function calculatePortfolioHistory(holdings, allPriceData) {
            if (!holdings || holdings.length === 0 || !allPriceData || allPriceData.length === 0) {
                return [];
            }
             console.log("üìä Calculating history with holdings:", holdings);
            console.log("üìä Raw data sample:", allPriceData.slice(0, 2));
            const holdingQuantities = holdings.reduce((acc, h) => {
                acc[h.stockId] = h.quantity;
                return acc;
            }, {});

            const portfolioAssetSymbols = Object.keys(holdingQuantities);

            // ÊîπËøõÔºöÂÖàÊåâÊó•ÊúüÊéíÂ∫èÂéüÂßãÊï∞ÊçÆ
            const sortedPriceData = allPriceData
                .filter(dataPoint => portfolioAssetSymbols.includes(dataPoint.name))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            // ÊåâÊó•ÊúüÂàÜÁªÑ
            const pricesByDate = sortedPriceData.reduce((acc, dataPoint) => {
                if (!acc[dataPoint.date]) {
                    acc[dataPoint.date] = {};
                }
                acc[dataPoint.date][dataPoint.name] = dataPoint.price;
                return acc;
            }, {});

            const portfolioHistory = [];
            const dates = Object.keys(pricesByDate).sort(); // Á°Æ‰øùÊó•ÊúüÈ°∫Â∫è

            for (const date of dates) {
                let dailyTotalValue = usd || 1000; // Èò≤Ê≠¢ usd Êú™ÂÆö‰πâ
                let hasAllPrices = true;
                
                for (const symbol of portfolioAssetSymbols) {
                    const price = pricesByDate[date][symbol];
                    const quantity = holdingQuantities[symbol];

                    if (price !== undefined && quantity !== undefined) {
                        dailyTotalValue += price * quantity;
                    } else {
                        hasAllPrices = false;
                        break;
                    }
                }

                // Âè™Ê∑ªÂä†ÊúâÂÆåÊï¥‰ª∑Ê†ºÊï∞ÊçÆÁöÑÊó•Êúü
                if (hasAllPrices) {
                    portfolioHistory.push({ 
                        date: date, 
                        value: dailyTotalValue,
                        dateObj: new Date(date) // È¢ÑËÆ°ÁÆóÊó•ÊúüÂØπË±°
                    });
                }
            }

            return portfolioHistory;
        }

        /**
         * [‰øÆÂ§ç] ÊîπËøõÁöÑÊ¶ÇËßàÂõæË°®Êõ¥Êñ∞ÂáΩÊï∞
         */
        function updateOverviewChart() {
            console.log('updateOverviewChart called'); // Ë∞ÉËØïÊó•Âøó
            
            if (!overviewChart || _rawData.length === 0) {
                console.log('Chart or data not ready');
                return;
            }
            
            const currentPortfolio = allPortfolios[currentPortfolioIndex];
            const portfolioId = `${currentPortfolioIndex}_${currentPortfolio.name}`;
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈáçÊñ∞ËÆ°ÁÆóÂéÜÂè≤Êï∞ÊçÆ
            if (currentPortfolioId !== portfolioId || !portfolioHistoryCache) {
                console.log('Recalculating portfolio history');
                portfolioHistoryCache = calculatePortfolioHistory(currentPortfolio.holdings, _rawData);
                currentPortfolioId = portfolioId;
            }

            // Ëé∑ÂèñËøáÊª§Êó•Êúü
            const startDateInput = document.getElementById('startDate');
            if (!startDateInput) {
                console.error('Start date input not found');
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            console.log('Filter date:', startDate);

            // ËøáÊª§Êï∞ÊçÆ - ‰ΩøÁî®È¢ÑËÆ°ÁÆóÁöÑÊó•ÊúüÂØπË±°
            const filteredData = portfolioHistoryCache.filter(d => d.dateObj >= startDate);
            console.log('Filtered data points:', filteredData.length);

            if (filteredData.length === 0) {
                console.log('No data after filtering');
                overviewChart.clear();
                return;
            }
            
            // ÂáÜÂ§áÂõæË°®Êï∞ÊçÆ
            const chartData = filteredData.map(item => ({
                date: item.date,
                value: item.value
            }));

            // ËÆ°ÁÆóÊï∞ÂÄºËåÉÂõ¥‰ª•‰ºòÂåñYËΩ¥
            const values = chartData.map(d => d.value);
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const padding = (maxValue - minValue) * 0.1; // 10% Â°´ÂÖÖ

            // Êõ¥Êñ∞ÂõæË°®ÈÖçÁΩÆ - ‰∏ç‰ΩøÁî® true ÂèÇÊï∞
            const option = {
                animationDuration: 1000, // ÂáèÂ∞ëÂä®ÁîªÊó∂Èó¥
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const data = params[0];
                        return `${data.axisValueLabel}<br/>Value: $${data.value.toLocaleString('en-US', { 
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2 
                        })}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: chartData.map(item => item.date),
                    axisLabel: {
                        rotate: 45, // ÊóãËΩ¨Êó•ÊúüÊ†áÁ≠æÈÅøÂÖçÈáçÂè†
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Total Value ($USD)',
                    min: Math.max(0, minValue - padding), // ËÆæÁΩÆÂêàÁêÜÁöÑÊúÄÂ∞èÂÄº
                    max: maxValue + padding,
                    axisLabel: {
                        formatter: function(value) {
                            if (value >= 1000000) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                            return '$' + value.toFixed(0);
                        }
                    },
                    scale: true
                },
                grid: {
                    left: 80,
                    right: 30,
                    top: 60,
                    bottom: 80 // Â¢ûÂä†Â∫ïÈÉ®Á©∫Èó¥ÂÆπÁ∫≥ÊóãËΩ¨ÁöÑÊ†áÁ≠æ
                },
                series: [{
                    name: 'Portfolio Value',
                    type: 'line',
                    data: chartData.map(item => item.value),
                    showSymbol: false,
                    smooth: false,
                    lineStyle: {
                        width: 3,
                        color: '#3498db'
                    },
                    areaStyle: {
                        opacity: 0.5,
                        color: 'rgba(52, 152, 219, 0.1)'
                    }
                    
                }]
            };

            // ‰ΩøÁî® notMerge: false Êù•Êõ¥Êñ∞ËÄåÈùûÊõøÊç¢ÈÖçÁΩÆ
            overviewChart.setOption(option, false);
            console.log('Chart updated successfully');
        }


        // 6. MAIN RENDER & INITIALIZATION
        /**
         * This is the main function to render the entire dashboard for a given portfolio.
         * @param {number} portfolioIndex - The index of the portfolio to render.
         */
       
        

// 6. MAIN RENDER & INITIALIZATION
        /**
         * This is the main function to render the entire dashboard for a given portfolio.
         * @param {number} portfolioIndex - The index of the portfolio to render.
         */

function initializeOverviewChart() {
    const dom = document.getElementById('overviewNetWorthChart');
    if (dom && !overviewChart) {
        overviewChart = echarts.init(dom);
        console.log('‚úÖ overviewChart initialized');
    }}
        function renderDashboard(portfolioIndex) {
            if (portfolioIndex < 0 || portfolioIndex >= allPortfolios.length) { portfolioIndex = 0; }
            currentPortfolioIndex = portfolioIndex;
            const activePortfolio = allPortfolios[portfolioIndex];

            // Adapt the data for the selected portfolio
            portfolioData = adaptDataStructure(activePortfolio);
            console.log("üîç Raw active portfolio:", activePortfolio);

            // Re-build the UI components
            buildSidebar(activePortfolio);
            updatePortfolioDropdown();
            initializePortfolioValues();
            updateMarketMovers(); // Update gainers and losers

            // Reset view to overview
            portfolioHistoryCache = null;
            currentPortfolioId = null;
            

            const { gainList, loseList } = calculateIncomeSpendingFromHoldings(activePortfolio.holdings);
            updateIncomeChart(gainList);
            updateSpendingChart(loseList);
            updateGainSpendingLabels(gainList, loseList);
            switchView('overview');
            
            if (!overviewChart) {console.warn("‚ö†Ô∏è overviewChart is not initialized!");}

            setTimeout(() => {
                initializeOverviewChart();
                overviewChart.resize();      // Á°Æ‰øùÊ∏≤ÊüìÊ≠£Á°Æ
                updateOverviewChart();
            }, 100)
            // updateTransactionTable();
            console.log(`Switched to portfolio: ${activePortfolio.name}`);
        }

        /**
         * Contains setup code that runs AFTER the data is loaded.
         */

        function initializeApp() {
            if (allPortfolios && allPortfolios.length > 0) {
                renderDashboard(0);
                updateOverviewChart();
            } else {
                updatePortfolioDropdown();
                document.getElementById('sidebar').innerHTML = "<h1>Please add a portfolio to begin.</h1>";
                document.getElementById('total').textContent = '$0.00';
            }
            const chartDom = document.getElementById('overviewNetWorthChart');
            overviewChart = echarts.init(chartDom);
            console.log(chartDom); 
            // ‰∏∫ ECharts ÂÆû‰æãÊ∑ªÂä† resize ÁõëÂê¨Âô®
            window.addEventListener('resize', () => {
                if (overviewChart) overviewChart.resize();
            });

            // [‰øÆÊîπ] Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤‰ª∑Ê†ºÊï∞ÊçÆÂπ∂Â≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè
        
            // [‰øÆÊîπ] Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤‰ª∑Ê†ºÊï∞ÊçÆÂπ∂Â≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè
            $.get('data/all_data.json', function (data) {
                _rawData = data; // Â≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ
                
                // Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºåÊ∏≤ÊüìÁ¨¨‰∏Ä‰∏™ÊäïËµÑÁªÑÂêà
                renderDashboard(0);
            
                // [‰øÆÊîπ] Êó•ÊúüÈÄâÊã©Âô®Áé∞Âú®Âè™Ëß¶ÂèëÂõæË°®Êõ¥Êñ∞Ôºå‰∏çÂÜçÂ§ÑÁêÜÂ§çÊùÇÈÄªËæë
                document.getElementById('startDate').addEventListener('change', updateOverviewChart);
                
            });




            //renderDashboard(0); // Render the first portfolio by default

            // Initialize OVERVIEW charts (static data for now)
            // const overviewNetWorthCtx = document.getElementById('overviewNetWorthChart').getContext('2d');
            
                        
      /*const incomeCtx = document.getElementById('incomeChart').getContext('2d');
            new Chart(incomeCtx, { type: 'doughnut', data: { datasets: [{ data: [18665, 5000], backgroundColor: ['#2ecc71', '#ecf0f1'], cutout: '70%' }] }, options: { plugins: { legend: { display: false } } } });
            const spendingCtx = document.getElementById('spendingChart').getContext('2d');
            new Chart(spendingCtx, { type: 'doughnut', data: { datasets: [{ data: [42500, 10000], backgroundColor: ['#e74c3c', '#ecf0f1'], cutout: '70%' }] }, options: { plugins: { legend: { display: false } } } });
        */
        
 
            // Initialize Modal event listeners
            //document.getElementById("addPortfolioForm").addEventListener("submit", function(e) { e.preventDefault(); const name = document.getElementById("portfolioName").value; const value = document.getElementById("portfolioValue").value; if (name && value) { localPortfolios.push({ name, value }); closeModal(); this.reset(); } });
            //document.getElementById("deletePortfolioForm").addEventListener("submit", function(e) { e.preventDefault(); const index = document.getElementById("portfolioToDelete").value; if (index !== null && index < localPortfolios.length) { localPortfolios.splice(index, 1); closeDeleteModal(); } });
        }

        function calculateIncomeSpendingFromHoldings(holdings) {
                const gainList = [];
                const loseList = [];

                holdings.forEach(asset => {
                    const { assetName, assetType, currentPrice, priceHistory, quantity,history} = asset;

                    // ÂèñÂéÜÂè≤‰ª∑Ê†ºÔºåthis is for test
                    const historyPrice = Array.isArray(priceHistory) && priceHistory.length > 0
                        ? priceHistory[priceHistory.length - 2] || priceHistory[0]
                        : currentPrice; // fallback

                    const diff = currentPrice-historyPrice; //- history;
                    const value = diff * quantity;

                    const roundedValue = Math.round(Math.abs(value) * 100) / 100;

                    const result = {
                        assetName,
                        assetType,
                        value: roundedValue
                    };


                    if (value >= 0) {
                        gainList.push(result);
                    } else {
                        loseList.push(result);
                    }
                });

                return {
                    gainList,
                    loseList
                };
            }

        function aggregateByAssetType(assetList) {
    const typeMap = {};

    assetList.forEach(item => {
        const { assetType, value } = item;
        if (!typeMap[assetType]) {
            typeMap[assetType] = 0;
        }
        typeMap[assetType] += value;
    });

    // ËøîÂõû ECharts ÊâÄÈúÄÁöÑÊï∞ÊçÆÁªìÊûÑ
    return Object.entries(typeMap).map(([type, total]) => ({
        name: type.charAt(0).toUpperCase() + type.slice(1), // Ê†ºÂºèÂåñÈ¶ñÂ≠óÊØç
        value: total
    }));
}

        function updateIncomeChart(gainList) {
    const chart = echarts.init(document.getElementById('incomeChart'));
    const pieData = aggregateByAssetType(gainList);

    const option = {
        color: [ '#1976d2',
  '#90caf9', // ÊµÖËìùÔºàSky BlueÔºâ
  '#64b5f6', // Ê∑°ËìùÔºàDodger BlueÔºâ
  '#42a5f5', // Â∏∏ËßÑËìùÔºàMedium BlueÔºâ
  '#2196f3', // Ê†áÂáÜËìùÔºàPrimary BlueÔºâ
  '#1e88e5', // Ê∑±ËìùÔºàOcean BlueÔºâ
  '#1976d2', // Ê∑±‰∏ÄÁÇπÁöÑËìù
  '#1565c0', // Â§úËìùÔºàNavyÔºâ
  '#0d47a1'  // ÊúÄÊ∑±ËìùÔºàMidnight BlueÔºâ
],
        tooltip: { trigger: 'item' },
        legend: {
            top: '5%',
            left: 'center',
            textStyle: { color: '#666' }
        },
        series: [{
            name: 'Income',
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            label: { show: false, position: 'center' },
            emphasis: {
                label: {
                    show: true,
                    fontSize: 30,
                    fontWeight: 'bold',
                    color: '#666'
                }
            },
            labelLine: { show: false },
            data: pieData
        }]
    };

    chart.setOption(option);
    chart.resize();
}

function updateSpendingChart(loseList) {
    const chart = echarts.init(document.getElementById('spendingChart'));
    const colorList = ["#e74c3c",
  '#ef9a9a', // ÊüîÂíåÁ∫¢ÔºàBlush RedÔºâ
  '#e57373', // Áï™ËåÑÁ∫¢ÔºàSoft CoralÔºâ
  '#ef5350', // È≤úÁ∫¢ÔºàTomatoÔºâ
  '#f44336', // Ê≠£Á∫¢ÔºàRedÔºâ
  '#e53935', // Ê∑±Á∫¢ÔºàDark RedÔºâ
  '#d32f2f', // ÈÖíÁ∫¢ÔºàWine RedÔºâ
  '#b71c1c'  // ÊúÄÊ∑±Á∫¢ÔºàMaroonÔºâ
];

    const pieData = aggregateByAssetType(loseList).map((item, index) => ({
        ...item,
        itemStyle: { color: colorList[index % colorList.length] }
    }));

    const option = {
        
        tooltip: { trigger: 'item' },
        legend: {
            top: '5%',
            left: 'center',
            textStyle: { color: '#666' }
        },
        series: [{
            name: 'Spending',
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            label: { show: false, position: 'center' },
            emphasis: {
                label: {
                    show: true,
                    fontSize: 30,
                    fontWeight: 'bold',
                    color: '#666'
                }
            },
            labelLine: { show: false },
            data: pieData
        }]
    };

    chart.setOption(option);
    chart.resize();
}


//ÂÆö‰πâËÇ°Á•®Êï∞ÁªÑÂØπÊó•ÊúüÁöÑËΩ¨Êç¢ÂáΩÊï∞
function convertPricesToObjects(prices, type, name, market = 'US') {
  const result = [];
  const holidays = getHolidays(new Date().getFullYear(), market); // Ëé∑ÂèñÂΩìÂâçÂπ¥‰ªΩÁöÑÂÅáÊúü
  let currentDate = new Date(); // ‰ªé‰ªäÂ§©ÂºÄÂßã
 
  // ÈÅçÂéÜËÇ°‰ª∑Êï∞ÁªÑÔºàÂÄíÂ∫èÂåπÈÖçÊó•ÊúüÔºâ
  for (let i = 0; i < prices.length; i++) {
    // Ë∑≥ËøáÂë®Êú´ÂíåÂÅáÊúüÔºåÁõ¥Âà∞ÊâæÂà∞‰∏Ä‰∏™‰∫§ÊòìÊó•
    while (isWeekend(currentDate) || holidays.includes(formatDate(currentDate))) {
      currentDate.setDate(currentDate.getDate() - 1); // ÂæÄÂâçÊé®‰∏ÄÂ§©
    }
 
    // ÁîüÊàêÂØπË±°
    result.push({
      type,
      name,
      date: formatDate(currentDate),
      price: prices[i],
    });
 
    // ÁªßÁª≠Â§ÑÁêÜÂâç‰∏Ä‰∏™‰∫§ÊòìÊó•
    currentDate.setDate(currentDate.getDate() - 1);
  }
 
  return result;
}
 
/**
 * Âà§Êñ≠ÊòØÂê¶ÊòØÂë®Êú´
 * @param {Date} date
 * @returns {boolean}
 */
function isWeekend(date) {
  const day = date.getDay();
  return day === 0 || day === 6; // 0=Âë®Êó•, 6=Âë®ÂÖ≠
}
 
/**
 * Ê†ºÂºèÂåñÊó•Êúü‰∏∫ 'YYYY-MM-DD'
 * @param {Date} date
 * @returns {string}
 */
function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
 
/**
 * Ëé∑ÂèñÊüêÂπ¥ÊüêÂ∏ÇÂú∫ÁöÑÊ≥ïÂÆöËäÇÂÅáÊó•ÔºàÁ§∫‰æãÊï∞ÊçÆÔºåÈúÄÊ†πÊçÆÂÆûÈôÖÊÉÖÂÜµË∞ÉÊï¥Ôºâ
 * @param {number} year
 * @param {string} market
 * @returns {string[]}
 */
function getHolidays(year, market) {
  // Á§∫‰æãÔºöÁæéÂõΩÂ∏ÇÂú∫ÂÅáÊúüÔºàÈÉ®ÂàÜÔºâ
  const usHolidays = [
    `${year}-01-01`, // ÂÖÉÊó¶
    `${year}-07-04`, // Áã¨Á´ãÊó•
    `${year}-12-25`, // Âú£ËØûËäÇ
    // ÂÖ∂‰ªñÂÅáÊúü...
  ];
 
  // Á§∫‰æãÔºö‰∏≠ÂõΩÂ∏ÇÂú∫ÂÅáÊúüÔºàÈÉ®ÂàÜÔºâ
  const cnHolidays = [
    `${year}-01-01`, // ÂÖÉÊó¶
    `${year}-05-01`, // Âä≥Âä®ËäÇ
    `${year}-10-01`, // ÂõΩÂ∫ÜËäÇ
    // ÂÖ∂‰ªñÂÅáÊúü...
  ];
 
  return market === 'US' ? usHolidays : cnHolidays;
}








function updateGainSpendingLabels(gainList, loseList) {
    const gainTotal = gainList.reduce((sum, item) => sum + item.value, 0);
    const loseTotal = loseList.reduce((sum, item) => sum + item.value, 0);

    const gainLabel = document.getElementById('gain-amount');
    const spendLabel = document.getElementById('spending-amount');

    if (gainLabel) {
        gainLabel.textContent = `$${gainTotal.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;
    }

    if (spendLabel) {
        spendLabel.textContent = `$${loseTotal.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;
    }
}


// 7. PAGE LOAD & UTILITY FUNCTIONS
        document.addEventListener('DOMContentLoaded', () => {
            fetch('data/portfolios.json')
                .then(response => { if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } return response.json(); })
                .then(jsonData => {
                   allPortfolios = jsonData.portfolios || [];
                    initializeApp();
                })
                .catch(error => {
                    console.error("Could not load or parse portfolio data:", error);
                    document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: sans-serif;"><h1>Error</h1><p>Could not load portfolio data. Please check the console for details.</p></div>`;
                });
        });


        //fetch news when initializing the page...
        let news_url = `http://localhost:3088/topNews`;
        fetch(news_url).then(response => {
            if (!response.ok) {
            throw new Error(`Stock request HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`News:`, data);
            //ÂÜôÂÖ•newsÂà∞dom‰∏≠
                document.getElementById(`topNews1`).innerHTML = `
                    <h3><a href="${data[0].url}" target="_blank">${data[0].title}</a></h3>
                    <div style="text-align: right;">
                    <span style="margin-right: 20px;">${data[0].source.name}</span>
                    <span> </span>
                    <span>${data[0].publishedAt}</span>
                    </div>
                    `;
                document.getElementById(`topNews2`).innerHTML = `
                    <h3><a href="${data[1].url}" target="_blank">${data[1].title}</a></h3>
                    <div style="text-align: right;">
                    <span style="margin-right: 20px;">${data[1].source.name}</span>
                    <span> </span>
                    <span>${data[1].publishedAt}</span>
                    </div>
                    `;
                document.getElementById(`topNews3`).innerHTML = `
                    <h3><a href="${data[2].url}" target="_blank">${data[2].title}</a></h3>
                    <div style="text-align: right;">
                    <span style="margin-right: 20px;">${data[2].source.name}</span>
                    <span> </span>
                    <span>${data[2].publishedAt}</span>
                    </div>
                    `;


                // document.getElementById(`topNews4`).innerHTML = `
                //     <h3><a href="${data[3].url}" target="_blank">${data[3].title}</a></h3>
                //     <div style="text-align: right;">
                //     <span style="margin-right: 20px;">${data[3].source.name}</span>
                //     <span> </span>
                //     <span>${data[3].publishedAt}</span>
                //     </div>
                //     `;
                // document.getElementById(`topNews${i}`)
            })
        .catch(error => {
            console.error('Error:', error);
        });


        let interval_1; //ÂÆö‰πâÂÆöÊó∂ÂØπË±°

        function startCounter() {
        interval_1 = setInterval(() => { 
            if (!portfolioData) return;
            let totalValue = usd;
            document.getElementById('usd').textContent = `$${usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                  for (const assetType in portfolioData) {
                for (const symbol in portfolioData[assetType]) {
                    // console.log(assetType , symbol);///
                    if(assetType == "stock") {
                    // ÂÖàËÅîÈÄöÂ§ñÁΩëÊâçËÉΩÂÜô‰∏ãÂéª//
                    let stock_url = `http://localhost:3088/currentStock/${symbol}`;
                    fetch(stock_url).then(response => {
                        if (!response.ok) {
                        throw new Error(`Stock request HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Stock ${symbol}:`, data);
                        portfolioData[assetType][symbol].price = data;//set dynamic value
                        // portfolioData[assetType][symbol].price = 0;///////////test visual effect to be 0
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    }else if(assetType == 'etf'){
                    let fund_url = `http://localhost:3088/currentFund/${symbol}`;
                    fetch(fund_url).then(response => {
                        if (!response.ok) {
                        throw new Error(`Stock request HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Fund ${symbol}:`, data);
                        portfolioData[assetType][symbol].price = data;//set dynamic value
                        // portfolioData[assetType][symbol].price = 0;///////////test visual effect to be 0
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    }else if(assetType == 'forex' ){
                    let forex_url = `http://localhost:3088/currentExchange/${symbol}`;
                    fetch(forex_url).then(response => {
                        if (!response.ok) {
                        throw new Error(`Stock request HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Forex ${symbol}:`, data);
                        portfolioData[assetType][symbol].price = data;//set dynamic value
                        // portfolioData[assetType][symbol].price = 0;///////////test visual effect to be 0
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    }else if(assetType == 'crypto'){
                    let crypto_url = `http://localhost:3088/currentCrypto/${symbol}`;
                    fetch(crypto_url).then(response => {
                        if (!response.ok) {
                        throw new Error(`Stock request HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Crypto ${symbol}:`, data);
                        portfolioData[assetType][symbol].price = data;//set dynamic value
                        // portfolioData[assetType][symbol].price = 0;///////////test visual effect to be 0
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                    }else{
                    console.log("Wrong portfolio type! Go check your portfolio definition!"+symbol+assetType);
                    }
                    const asset = portfolioData[assetType][symbol];
                    const holdingValue = asset.holding * asset.price;
                    totalValue += holdingValue;
                    const element = document.getElementById(`${symbol.toLowerCase()}-holding-value`);
                    if (element) {
                        element.textContent = `$${holdingValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                }
            }
            document.getElementById('total').textContent = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        //update index!
        let index_array = ["GSPC", "DJI", "IXIC", "TNX"];
        for (const index_item of index_array){
            console.log("requesting index object:", index_item);
            let index_url = `http://localhost:3088/currentIndex/^${index_item}`;
            fetch(index_url).then(response => {
                if (!response.ok) {
                throw new Error(`Index request HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Index ${index_item}:`, data);
                document.getElementById(index_item).textContent = `${data.toLocaleString( { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                // 
            })
            .catch(error => {
                console.error('Error:', error);
            });
        };

        const stock_invest_type = ['NVDA', 'TSLA', 'HSBC', 'MSFT', 'GOOGL','SPY', 'QQQ', 'GLD', 'AGG'];
        for(const stock_item of stock_invest_type){
            console.log("requesting chart object:", stock_item);
            let url = `http://localhost:3088/stockPriceChart/${stock_item}`;
            fetch(url).then(response => {
                if (!response.ok) {
                throw new Error(`Index request HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Stock Chart ${stock_item}:`, data);
                // transform into date json (Êï∞ÁªÑËΩ¨object)
                const type = "Stock";
                const name = stock_item;
                const stockData = convertPricesToObjects(data, type, name, 'US'); //us market
                console.log(stockData); //ÂæóÂà∞‰∫ÜobjectÔºÅ
                //write to json at upper folder ÔºàobjectÂÜôÂÖ•jsonÊñá‰ª∂Ôºâ
                //////////////////‰∏çË¶ÅÂÜôÂÖ•Âà∞Êñá‰ª∂//////////////////////////////////////////‰ΩøÁî®ÂèòÈáè‰º†ÂèÇÁªôchartÂç≥ÂèØÔºÅ-------------@todo

            })
            .catch(error => {
                console.error('Stock Chart Fetch Error:', error);
            });
        }
        }, 10000); // Update every 10 second
        }


        function stopCounter() { clearInterval(interval_1);}

    // Start the counter when the page loads
        startCounter();

        function toggleSection(sectionId) { document.getElementById(sectionId + '-content').classList.toggle('collapsed'); }
        let currentSlide = 0;
        function showSlide(index) { const carouselInner = document.getElementById('carouselInner'); const totalSlides = carouselInner.children.length; currentSlide = (index + totalSlides) % totalSlides; carouselInner.style.transform = 'translateX(' + (-currentSlide * 100) + '%)'; }
        function nextSlide() { showSlide(currentSlide + 1); }
        function prevSlide() { showSlide(currentSlide - 1); }
        //function openModal() { document.getElementById('addPortfolioModal').style.display = 'flex'; }
        //function closeModal() { document.getElementById('addPortfolioModal').style.display = 'none'; }
        //function openDeleteModal() { const select = document.getElementById("portfolioToDelete"); select.innerHTML = ''; localPortfolios.forEach((p, index) => { const option = document.createElement("option"); option.value = index; option.textContent = `${p.name} - $${parseFloat(p.value).toLocaleString()}`; select.appendChild(option); }); document.getElementById("deletePortfolioModal").style.display = "flex"; }
        //function closeDeleteModal() { document.getElementById("deletePortfolioModal").style.display = "none"; }
 
    </script>
</body>
</html>
